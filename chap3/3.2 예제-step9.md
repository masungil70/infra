### Terraform `remote-exec`를 사용하여 SSH로 VM에 접속하여 스크립트 내용을 직접 실행 

1. remote-exec의 개념과 원리

remote-exec 프로비저너는 Terraform이 리소스(여기서는 Proxmox VM) 생성을 완료한 직후, 해당 리소스에 원격으로 접속하여 명령어를 실행하는 기능입니다. 동작 원리는 다음과 같습니다.

  1. VM이 생성되고 IP 주소를 할당받는다.
  2. Terraform은 그 IP 주소로 SSH 접속을 시도한다.
  3. 접속에 성공하면, 지정된 명령어들을 순차적으로 실행한다.

2. remote-exec 사용 방법 및 코드 상세 설명

이 provisioner 블록은 resource "proxmox_vm_qemu" "ubuntu_vm" 내부에 위치해야 합니다.

```terraform
# 원격-실행 프로비저너: VM에 연결하여 qemu-guest-agent 설치
provisioner "remote-exec" {

   # 1. 실행할 명령어 목록 (inline)
   inline = [
     "sudo apt-get update -y",
     "sudo apt-get install -y qemu-guest-agent",
     "sudo systemctl start qemu-guest-agent",
     "sudo systemctl enable qemu-guest-agent"
   ]

   # 2. 원격 접속 정보 (connection)
   connection {
     type        = "ssh"
     user        = var.ciuser
     password    = var.cipassword
     host        = self.default_ipv4_address
   }
 }
```

① inline 블록: 실행할 명령어

  - inline은 원격 VM에서 실행할 셸 명령어들을 문자열 배열(리스트) 형태로 나열하는 곳입니다.
  - 명령어들은 위에서부터 아래로 순서대로 실행됩니다.
  - sudo: 관리자 권한이 필요한 명령(패키지 설치 등)을 위해 사용합니다.
  - -y: apt-get install 시 "정말 설치하시겠습니까? (Y/n)" 같은 사용자 확인 프롬프트를 자동으로 'Yes'로 응답하여, 스크립트가 중간에 멈추지 않도록 합니다.

팁: 실행할 명령이 많고 복잡하다면 inline 대신, 셸 스크립트 파일(.sh)을 만들고 script = "경로/내_스크립트.sh" 와 같이 지정하여 해당 스크립트 파일을 업로드하고 실행하게 할 수도 있습니다.

② connection 블록: 원격 접속 방법

remote-exec가 VM에 어떻게 접속할지 정의하는 핵심 부분입니다.

- type = "ssh": 접속 프로토콜로 SSH를 사용하겠다고 지정합니다.
- user = var.ciuser: SSH 접속에 사용할 사용자 이름입니다. (VM 템플릿에 미리 생성되어 있거나, Cloud-Init 기본 설정으로 생성된 사용자)
- password = var.cipassword: 위 사용자의 암호입니다.
- host = self.default_ipv4_address: 접속할 대상 VM의 IP 주소입니다.
  - self는 이 프로비저너가 속한 리소스, 즉 proxmox_vm_qemu.ubuntu_vm를 가리킵니다.
  - default_ipv4_address는 해당 VM 리소스가 생성된 후 할당받은 IP 주소 속성(attribute)입니다. Terraform은 이 값이 나타날 때까지 기다린 후 프로비저너를 실행합니다.

보안 권장 사항: 암호를 직접 사용하는 것보다 SSH 키를 사용하는 것이 훨씬 안전합니다.

```
connection {
  type        = "ssh"
  user        = "ubuntu"
  private_key = file("~/.ssh/id_rsa") # 로컬 PC의 개인키 파일 경로
  host        = self.default_ipv4_address
}
```

이 경우, VM 템플릿에는 해당 개인키와 쌍을 이루는 공개키가 미리 `~/.ssh/authorized_keys` 파일에 등록되어 있어야 합니다.

### 3. 전체 실행 절차 (`terraform apply` 실행 시)

step9.tf 파일에 원격-실행 프로비저너 개인키 파일 설정
```
vi step9.tf
...
  # 원격-실행 프로비저너: VM에 연결하여 qemu-guest-agent 설치
  provisioner "remote-exec" {
    inline = [
      "sudo apt-get update -y",
      "sudo apt-get install -y qemu-guest-agent",
      "sudo systemctl start qemu-guest-agent",
      "sudo systemctl enable qemu-guest-agent"
    ]

    # SSH 연결 정보
    connection {
      type        = "ssh"
      user        = var.ciuser
      private_key = file("~/.ssh/id_rsa") # 로컬 PC의 개인키 파일 경로
      host        = var.static_ip
      timeout     = "5m"
    }
  }

...
```

1. 사용자가 terraform apply를 실행합니다.
2. Terraform은 Proxmox API를 통해 clone으로 지정된 템플릿을 복제하여 VM 생성을 요청합니다.
3. VM이 부팅되고, 네트워크 설정(ipconfig0 = "ip=dhcp")에 따라 DHCP 서버로부터 IP 주소를 할당받습니다.
4. Proxmox는 할당된 IP 주소를 Terraform에 알려주고, Terraform은 이 값을 proxmox_vm_qemu.ubuntu_vm 리소스의 default_ipv4_address 속성에 기록합니다.
5. remote-exec 프로비저너가 동작을 시작합니다.
6. connection 블록의 정보를 읽어, host에 지정된 IP 주소로 user와 password를 이용해 SSH 접속을 시도합니다.
7. SSH 접속에 성공하면, inline에 정의된 명령어들을 위에서부터 순서대로 하나씩 실행합니다.
8. 만약 어느 한 명령어라도 실패하여 0이 아닌 종료 코드(exit code)를 반환하면, 프로비저너는 실패로 간주하고 terraform apply 전체 프로세스를 오류와 함께 중단시킵니다.
9. 모든 명령어가 성공적으로 실행되면(종료 코드 0), 프로비저너는 성공적으로 종료되고 terraform apply의 나머지 과정이 진행됩니다.

이처럼 remote-exec는 Terraform의 워크플로우 안에서 VM 생성과 초기 설정을 순차적으로 자동화하는 강력한 방법입니다.

#### 실행 방법:
```bash
terraform init
terraform plan
terraform apply -auto-approve
```

#### 실행 결과:
```
...
proxmox_vm_qemu.ubuntu_vm (remote-exec): Scanning linux images... [====         ]
proxmox_vm_qemu.ubuntu_vm (remote-exec): Scanning linux images... [========     ]
proxmox_vm_qemu.ubuntu_vm (remote-exec): Scanning linux images... [=============]
proxmox_vm_qemu.ubuntu_vm (remote-exec): Scanning linux images...

proxmox_vm_qemu.ubuntu_vm (remote-exec): Running kernel seems to be up-to-date.

proxmox_vm_qemu.ubuntu_vm (remote-exec): No services need to be restarted.

proxmox_vm_qemu.ubuntu_vm (remote-exec): No containers need to be restarted.

proxmox_vm_qemu.ubuntu_vm (remote-exec): No user sessions are running outdated
proxmox_vm_qemu.ubuntu_vm (remote-exec):  binaries.

proxmox_vm_qemu.ubuntu_vm (remote-exec): No VM guests are running outdated
proxmox_vm_qemu.ubuntu_vm (remote-exec):  hypervisor (qemu) binaries on this
proxmox_vm_qemu.ubuntu_vm (remote-exec):  host.
proxmox_vm_qemu.ubuntu_vm (remote-exec): Synchronizing state of qemu-guest-agent.service with SysV service script with /lib/systemd/systemd-sysv-install.
proxmox_vm_qemu.ubuntu_vm (remote-exec): Executing: /lib/systemd/systemd-sysv-install enable qemu-guest-agent
proxmox_vm_qemu.ubuntu_vm (remote-exec): The unit files have no installation config (WantedBy=, RequiredBy=, Also=,
proxmox_vm_qemu.ubuntu_vm (remote-exec): Alias= settings in the [Install] section, and DefaultInstance= for template
proxmox_vm_qemu.ubuntu_vm (remote-exec): units). This means they are not meant to be enabled using systemctl.

proxmox_vm_qemu.ubuntu_vm (remote-exec): Possible reasons for having this kind of units are:
proxmox_vm_qemu.ubuntu_vm (remote-exec): • A unit may be statically enabled by being symlinked from another unit's
proxmox_vm_qemu.ubuntu_vm (remote-exec):   .wants/ or .requires/ directory.
proxmox_vm_qemu.ubuntu_vm (remote-exec): • A unit's purpose may be to act as a helper for some other unit which has
proxmox_vm_qemu.ubuntu_vm (remote-exec):   a requirement dependency on it.
proxmox_vm_qemu.ubuntu_vm (remote-exec): • A unit may be started when needed via activation (socket, path, timer,
proxmox_vm_qemu.ubuntu_vm (remote-exec):   D-Bus, udev, scripted systemctl call, ...).
proxmox_vm_qemu.ubuntu_vm (remote-exec): • In case of template units, the unit is meant to be enabled with some
proxmox_vm_qemu.ubuntu_vm (remote-exec):   instance name specified.
proxmox_vm_qemu.ubuntu_vm: Creation complete after 1m12s [id=masungil1/qemu/104]
```

생성된 가상머신의 요약에 부분에 IP 주소가 표시됩니다.
