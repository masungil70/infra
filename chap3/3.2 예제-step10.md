### terraform 출력

Terraform의 출력(Outputs)은 생성된 인프라에 대한 정보를 표시하고, 다른 Terraform 작업 공간에서 사용하거나, 자동화 스크립트에 전달하는 데 사용되는 중요한 기능입니다.

1. Outputs의 목적

* 정보 노출: terraform apply 실행 후 VM의 IP 주소, 데이터베이스 엔드포인트, S3 버킷 이름 등 중요한 정보를 터미널에 표시합니다.
* 데이터 공유: 한 Terraform 모듈이나 작업 공간(workspace)에서 생성된 리소스의 속성을 다른 작업 공간에서 terraform_remote_state 데이터 소스를 통해 참조할 수 있게 합니다.
* 자동화 연동: 셸 스크립트나 다른 자동화 도구에서 terraform output 명령어를 사용하여 생성된 인프라 정보를 JSON 형식 등으로 가져와 후속 작업을 처리할 수 있습니다.

2. 기본 구문

출력은 output 블록을 사용하여 정의합니다. 보통 outputs.tf 라는 별도의 파일에 모아두는 것이 일반적입니다.
```
output "출력_이름" {
  value       = # 여기에 출력할 값을 입력합니다.
  description = "이 출력에 대한 설명입니다." # 선택 사항
  sensitive   = false # 민감한 정보인 경우 true로 설정, 선택 사항
}
```

* 출력_이름: 이 출력을 식별하는 이름입니다. terraform output <출력_이름> 명령어로 특정 출력값만 조회할 때 사용됩니다.
* value: 필수 항목으로, 출력할 값을 지정합니다. 리소스의 속성, 변수, 다른 모듈의 출력 등 모든 Terraform 표현식을 사용할 수 있습니다.
* description: (선택 사항) 출력의 목적을 설명하는 문장입니다. 가독성을 높여줍니다.
* sensitive: (선택 사항) true로 설정하면 terraform apply 실행 시 이 출력값은 터미널에 표시되지 않고 <sensitive> 로 나타납니다. 비밀번호, API 키, 비공개 키 등 민감한 정보를 다룰 때 사용합니다. 값은 state 파일에 일반 텍스트로 저장되지만, 화면 출력은 막아줍니다.

3. 사용 예시

예시 1: 단일 가상머신의 IP 주소 출력하기

가장 흔한 사용 사례입니다. proxmox_vm_qemu 리소스 생성 후 할당된 IP 주소를 출력합니다.
```
# main.tf
resource "proxmox_vm_qemu" "ubuntu_vm" {
  # ... 리소스 설정 ...
  name = "kosa-server"
  # ...
}

# outputs.tf
output "server_ip" {
  description = "서버의 기본 IPv4 주소입니다."
  value       = proxmox_vm_qemu.ubuntu_vm.default_ipv4_address
}
```

terraform apply를 실행하면 작업이 끝난 후 다음과 같이 출력됩니다.

```
Outputs:

  server_ip = "192.168.1.123"
```

예시 2: 여러 가상머신의 IP 주소 목록 출력하기 (for_each 사용)

for_each 나 count를 사용하여 여러 리소스를 생성했을 때, 그 값들을 목록이나 맵(map) 형태로 출력할 수 있습니다.

```
# main.tf
resource "proxmox_vm_qemu" "app_servers" {
  for_each = toset(["app1", "app2"])
  # ... 리소스 설정 ...
  name = each.key
  # ...
}

# outputs.tf
output "app_server_ips" {
  description = "모든 앱 서버의 IP 주소 목록입니다."
  value       = { for vm_name, vm in proxmox_vm_qemu.app_servers : vm_name => vm.default_ipv4_address }
}
```

terraform apply 실행 후 출력:
```
Outputs:

app_server_ips = {
  "app1" = "192.168.1.124"
  "app2" = "192.168.1.125"
}
```

예시 3: 민감한 정보 출력하기 (예: 데이터베이스 비밀번호)

random_password 리소스를 사용하여 생성한 비밀번호를 출력하지만, 화면에는 노출하지 않습니다.
```
# main.tf
resource "random_password" "db_password" {
  length  = 16
  special = true
}

# outputs.tf
output "database_password" {
  description = "데이터베이스 루트 사용자의 비밀번호입니다."
  value       = random_password.db_password.result
  sensitive   = true
}
```

terraform apply 실행 후 출력:
```
Outputs:

database_password = <sensitive>
```

이 값은 terraform output database_password 명령어로도 직접 볼 수 없으며, terraform output -json을 사용하여 다른 프로그램으로 값을 전달할 때만 평문으로 나타납니다.

4. 출력 값 조회하기

apply가 완료된 후 언제든지 terraform output 명령어로 출력 값을 다시 확인할 수 있습니다.

* 모든 출력 보기:
```
   terraform output
```

* 특정 출력 보기:
  terraform output <출력_이름>

```  
   terraform output web_server_ip
```

* JSON 형식으로 보기 (스크립트에서 사용 시 유용):
```
  terraform output -json
```  
민감한(sensitive) 출력도 JSON 형식에서는 일반 텍스트로 표시되므로 출력을 파이프라인으로 다른 프로세스에 전달할 때 주의해야 합니다.

이처럼 Terraform Outputs는 생성된 인프라의 상태를 확인하고 다른 시스템과 연동하는 데 필수적인 기능입니다.

#### 실행 방법:
```bash
terraform init
terraform plan
terraform apply -auto-approve
```

#### 실행 결과:
```
Plan: 1 to add, 0 to change, 0 to destroy.

Changes to Outputs:
  + server_ip = (known after apply)

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes

proxmox_vm_qemu.ubuntu_vm: Creating...
proxmox_vm_qemu.ubuntu_vm: Still creating... [00m10s elapsed]
proxmox_vm_qemu.ubuntu_vm: Still creating... [00m20s elapsed]
proxmox_vm_qemu.ubuntu_vm: Still creating... [00m30s elapsed]
proxmox_vm_qemu.ubuntu_vm: Still creating... [00m40s elapsed]
proxmox_vm_qemu.ubuntu_vm: Still creating... [00m50s elapsed]
proxmox_vm_qemu.ubuntu_vm: Still creating... [01m00s elapsed]
proxmox_vm_qemu.ubuntu_vm: Still creating... [01m10s elapsed]
proxmox_vm_qemu.ubuntu_vm: Still creating... [01m20s elapsed]
proxmox_vm_qemu.ubuntu_vm: Creation complete after 1m30s [id=masungil1/qemu/104]

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.

Outputs:

server_ip = "192.168.0.6"
```

---
