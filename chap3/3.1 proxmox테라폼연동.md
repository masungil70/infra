## 3.1 Proxmox 서버와 Terrafor연동

 Terraform을 사용하면 VM 생성, 설정 변경, 삭제 등의 작업을 코드로 명시하고 자동화할 수 있어 매우 효율적이고 일관된 인프라 관리가 가능해집니다.

  Proxmox에서 Terraform을 사용하기 위한 전체 설정 과정을 단계별 알아보겠습니다

  ---

  전체 과정 요약

   1. Proxmox 서버 설정: Terraform이 Proxmox API에 접근할 수 있도록 전용 사용자 계정, 역할, API 토큰을 생성합니다.
   2. 클라이언트 PC 설정: Terraform을 설치하고, Proxmox와 통신하기 위한 Provider 및 리소스 구성 파일을 작성합니다.
   3. Terraform 실행: 작성한 코드를 바탕으로 Proxmox에 VM 등의 리소스를 배포합니다.

  ---

  1단계: Proxmox 서버 설정 (사용자 및 API 토큰 생성)

  Terraform이 Proxmox API에 안전하게 접근할 수 있도록 전용 사용자 계정과 API 토큰을 만듭니다. root 계정을 직접 사용하는 것은 보안상 매우 위험하므로 반드시 전용 계정을 생성하는 것을 권장합니다.

  Proxmox 웹 UI에 접속하여 아래 순서대로 진행하세요.

  1-1. 역할(Role) 생성

  Terraform에 필요한 최소한의 권한만 가진 역할을 새로 만듭니다.

   1. [데이터센터] -> [권한] -> [역할] 메뉴로 이동합니다.
   2. [생성] 버튼을 클릭하고 역할 ID에 TerraformProv와 같이 식별하기 쉬운 이름을 입력합니다.
   3. 권한 목록에서 Terraform이 VM을 생성하고 관리하는 데 필요한 권한들을 체크합니다. 아래는 일반적으로 필요한 권한들입니다.
```
      Datastore.AllocateSpace
      Datastore.AllocateTemplate
      Datastore.Audit
      Pool.Allocate
      Pool.Audit
      SDN.Use
      Sys.Audit
      Sys.Console
      Sys.Modify
      VM.Allocate
      VM.Audit
      VM.Clone
      VM.Config.CDROM
      VM.Config.Cloudinit
      VM.Config.CPU
      VM.Config.Disk
      VM.Config.HWType
      VM.Config.Memory
      VM.Config.Network
      VM.Config.Options
      VM.GuestAgent.Audit
      VM.GuestAgent.Unrestricted
      VM.Migrate
      VM.PowerMgmt
```

   5. [생성] 버튼을 눌러 역할을 만듭니다.

  1-2. 사용자(User) 생성

  Terraform이 사용할 전용 사용자를 생성합니다.

   1. [데이터센터] -> [권한] -> [사용자] 메뉴로 이동합니다.
   2. [추가] 버튼을 클릭하고 사용자 정보를 입력합니다.
       * 사용자 이름: terraform-prov
       * 영역(Realm): Proxmox VE authentication server (ID 뒤에 @pve가 붙습니다)
       * 암호: 강력한 암호를 설정합니다.

  1-3. 권한(Permission) 할당

  방금 만든 사용자와 역할을 연결합니다.

   1. [데이터센터] -> [권한] 메뉴에서 [추가] -> [사용자 권한 추가]를 선택합니다.
   2. 아래와 같이 설정하고 [추가] 버튼을 누릅니다.
       * 경로: / (루트 경로, 전체 데이터센터에 권한 부여)
       * 사용자: terraform-prov@pve
       * 역할: TerraformProv (방금 만든 역할)

  1-4. API 토큰(API Token) 생성

  Terraform이 암호 대신 사용할 API 토큰을 생성합니다.

   1. [데이터센터] -> [권한] -> [API 토큰] 메뉴로 이동합니다.
   2. [추가] 버튼을 클릭합니다.
       * 사용자: terraform-prov@pve
       * 토큰 ID: terraform-token (식별하기 쉬운 이름)
       * 권한 분리: 체크 해제 (토큰이 사용자의 모든 권한을 상속받도록 함)
   3. [추가] 버튼을 누르면 토큰 ID와 시크릿(Secret) 값이 표시됩니다.
      > ⚠️ 매우 중요: 생성된 토큰 ID (`terraform-prov@pve!terraform-token`) 와 시크릿 값을 즉시 복사하여 안전한 곳에 보관하세요. 시크릿 값은 이 창을 닫으면 다시는 볼 수 없습니다.

  ---

  2단계: Terraform 및 Proxmox Provider 설정 (클라이언트 PC)

  이제 Proxmox를 제어할 PC에서 Terraform을 설정합니다.

  2-1. Terraform 설치

  사용하는 OS에 맞게 Terraform 공식 홈페이지 (https://developer.hashicorp.com/terraform/install)의 가이드를 따라 Terraform을 설치합니다.

  윈도우10 운영체제에 Terraform을 설치하는 방법은 크게 두 가지 방법이 있습니다: 수동 설치 (권장)와 Winget을 이용한 설치입니다.

  ---

  방법 1: 수동 설치 (권장 - PATH 환경 변수 이해에 도움)

  이 방법은 Terraform 실행 파일을 직접 다운로드하고 시스템의 PATH 환경 변수에 추가하는 방식입니다.

  1단계: Terraform 다운로드

   1. 공식 HashiCorp 웹사이트 접속:
      Terraform 다운로드 페이지 (https://developer.hashicorp.com/terraform/downloads)에 접속합니다.
   2. Windows 64-bit 버전 선택:
      페이지에서 Windows 섹션을 찾아 amd64 (64-bit) 버전을 클릭하여 .zip 파일을 다운로드합니다.

  2단계: 다운로드한 파일 압축 해제

   1. 다운로드된 terraform_x.x.x_windows_amd64.zip 파일 (여기서 x.x.x는 버전 번호)을 마우스 오른쪽 버튼으로 클릭하고 [모두 압축 풀기...]를 선택합니다.
   2. 압축을 풀면 terraform.exe 실행 파일이 나타납니다.

  3단계: Terraform 실행 파일 배치

  terraform.exe 파일을 시스템의 PATH에 등록될 안전한 위치로 이동합니다. 보통 C:\Program Files 폴더 안에 별도의 폴더를 만들어 관리하는 것이 좋습니다.

   1. C:\Program Files 폴더 안에 Terraform이라는 새 폴더를 만듭니다. (예: C:\Program Files\Terraform)
   2. 압축을 풀어 나온 terraform.exe 파일을 C:\Program Files\Terraform 폴더로 이동합니다.

  4단계: 환경 변수 (PATH)에 Terraform 추가

  이 단계가 가장 중요합니다. PATH 환경 변수에 Terraform 실행 파일의 경로를 추가해야 터미널(명령 프롬프트 또는 PowerShell)의 어느 위치에서든 terraform 명령어를 사용할 수 있습니다.

   1. [Windows 시작] 버튼을 마우스 오른쪽 버튼으로 클릭하고 [시스템]을 선택합니다.
       * 또는, 시작 메뉴 검색창에 "환경 변수"를 입력하고 [시스템 환경 변수 편집]을 선택합니다.
   2. [시스템 속성] 창에서 [환경 변수(N)...] 버튼을 클릭합니다.
   3. [환경 변수] 창 하단의 '시스템 변수(S)' 섹션에서 Path 변수를 찾아 선택한 후 [편집(I)...] 버튼을 클릭합니다.
   4. [환경 변수 편집] 창에서 [새로 만들기(N)]를 클릭하고, C:\Program Files\Terraform 경로를 입력한 뒤 [확인]을 클릭합니다.
   5. 모든 열려있는 환경 변수 창들을 [확인] 버튼을 눌러 닫습니다.

  5단계: 설치 확인

   1. 새로운 명령 프롬프트 또는 PowerShell 창을 엽니다.
   2. 다음 명령어를 입력하고 Enter 키를 누릅니다.

```
terraform --version
```

   3. 성공적으로 설치되었다면, 현재 설치된 Terraform의 버전 정보가 출력됩니다. (예: Terraform v1.x.x 또는 Terraform v1.x.x on windows_amd64)

  2-2. VM 템플릿 준비 
     1. proxmox 서버에 ssh 로 로그인 합니다 
     
  ```
  ssh root@서버
  ```

     2. 가상 머신 템플릿을 ubuntu-2204-template 이름으로 생성합니다 .
        ```
        #가상머신 생성 
        qm create 9000 --name  ubuntu-2204-template

        # 클라우드 이미지를 다운로드한다
        wget https://cloud-images.ubuntu.com/releases/jammy/release-20221201/jammy-server-cloudimg-amd64.img

        # 다운로드한 이미지를 저장소에 디스크로 임포트 한다
        qm importdisk 9000 jammy-server-cloudimg-amd64.img local-lvm

        # GUI로 이동하여 가상머신에 추가된 디스크를 사용 할 수 있게 설정한다 

        # 가상머신을 템플릿 이미지로 변환한다
        
        
        ```

  2-3. Terraform 구성 파일 작성

   1. PC에 새로운 프로젝트 폴더를 만듭니다. (예: proxmox-tf)
   2. 해당 폴더 안에 main.tf 라는 파일을 생성하고 아래 내용을 작성합니다.

```bash
vi main.tf

# 사용할 프로바이더와 버전 설정
terraform {
  required_providers {
    proxmox = {
      # 참고: 이 코드는 telmate/proxmox 프로바이더 문법을 기준으로 합니다.
      source  = "telmate/proxmox"
      version = "3.0.2-rc06"
    }
  }
}

# Proxmox 프로바이더 구성
# 실제 접속 정보는 terraform.tfvars 파일에서 가져옵니다.
provider "proxmox" {
  pm_api_url          = var.proxmox_api_url
  pm_api_token_id     = var.proxmox_api_token_id
  pm_api_token_secret = var.proxmox_api_token_secret

  # 자체 서명 인증서 사용 시 필요
  pm_tls_insecure = true
}

# Proxmox 프로바이더 연결에 필요한 변수
variable "proxmox_api_url" {
  type        = string
  description = "Proxmox API의 전체 URL 주소 (예: https://1.2.3.4:8006/api2/json)"
  sensitive   = true
}

variable "proxmox_api_token_id" {
  type        = string
  description = "Proxmox API 토큰 ID (예: user@pve!token-name)"
  sensitive   = true
}

variable "proxmox_api_token_secret" {
  type        = string
  description = "Proxmox API 토큰 Secret"
  sensitive   = true
}

# VM 생성을 위해 필요한 변수
variable "vm_name" {
  type        = string
  description = "생성할 가상머신의 이름"
}

variable "proxmox_node" {
  type        = string
  description = "VM을 생성할 대상 Proxmox 노드의 이름"
}

variable "template_name" {
  type        = string
  description = "복제에 사용할 템플릿의 이름"
}

variable "ssh_public_key" {
  type        = string
  description = "VM에 주입할 사용자의 SSH 공개 키"
  sensitive   = true
}

# Proxmox VM 리소스 정의
resource "proxmox_vm_qemu" "ubuntu_vm" {
  # VM의 이름 설정
  name        = var.vm_name
  # VM이 배포될 Proxmox 노드의 이름
  target_node = var.proxmox_node
  # 복제할 템플릿의 이름
  clone       = var.template_name
  # VM 생성 시 풀 클론(독립적인 복사본)을 수행할지 여부
  full_clone  = true

  # 운영체제 타입 설정 (Cloud-Init을 사용)
  os_type = "cloud-init"
  # QEMU Guest Agent 활성화 (VM과 호스트 간 통신)
  agent   = 1

  # CPU 설정
  cpu {
    # 할당할 CPU 코어 수
    cores = 2
    # 할당할 CPU 소켓 수
    sockets = 1
  }

  # 할당할 메모리 양 (MB 단위)
  memory = 2048
  # SCSI 컨트롤러 하드웨어 타입 (성능 향상을 위해 VirtIO SCSI 권장)
  scsihw  = "virtio-scsi-pci"
  # 부팅 순서 (scsi0 디스크로 부팅)
  boot    = "order=scsi0"

  # 메인 디스크 설정 (루트 디스크)
  disk {
    # 디스크 슬롯 (scsi0)
    slot    = "scsi0"
    # 디스크 크기 (32GB)
    size    = "32G"
    # 디스크 종류 (일반 디스크)
    type    = "disk"
    # 디스크 저장소 (예: local-lvm)
    storage = "local-lvm"
  }

  # Cloud-Init 드라이브 설정
  disk {
    # 디스크 슬롯 (ide2는 일반적으로 Cloud-Init CD-ROM 드라이브에 사용)
    slot    = "ide2"
    # 디스크 종류 (Cloud-Init 드라이브)
    type    = "cloudinit"
    # 디스크 저장소
    storage = "local-lvm"
  }

  # 네트워크 인터페이스 설정
  network {
    # 네트워크 인터페이스 ID (net0)
    id     = 0
    # 네트워크 카드 모델 (VirtIO는 성능이 좋음)
    model  = "virtio"
    # 연결할 가상 브릿지
    bridge = "vmbr0"
  }

  # Cloud-Init을 통한 IP 설정 (DHCP로 IP 자동 할당)
  ipconfig0 = "ip=dhcp"

  # Cloud-Init 커스텀 설정 (QEMU Guest Agent 설정 파일)
  # 스니펫 활성화를 위해 Proxmox 웹 UI에서 아래 경로에 스니펫 활성화 하고 파일을 생성해야 합니다.
  # 데이터센터 -> 스토리지 -> local -> 수정 -> 내용에 스니펫 추가
  # 서버 노드에 root 권한으로 접속하여 /var/lib/vz/snippets/ 경로에 qemu-guest-agent.yml 파일을 생성하면 됩니다 
  #
  # qemu-guest-agent.yml 파일 생성 예시:
  # tee /var/lib/vz/snippets/qemu-guest-agent.yml <<EOF
  # #cloud-config
  # runcmd:
  #  - apt update
  #  - apt install -y qemu-guest-agent
  #  - systemctl start qemu-guest-agent
  # EOF
  cicustom   = "vendor=local:snippets/qemu-guest-agent.yml" # /var/lib/vz/snippets/qemu-guest-agent.yml 파일 경로
  # Cloud-Init 업그레이드 활성화
  ciupgrade  = true
  # Cloud-Init 사용자 이름
  ciuser     = "kosa"
  # Cloud-Init 사용자 암호
  cipassword = "kosa1004"
  # SSH 공개 키 (VM에 SSH 접속용)
  sshkeys    = var.ssh_public_key

  # VGA 설정
  vga {
    # VGA 타입 (표준)
    type = "std"
  }

  # Terraform 라이프사이클 관리 설정
  lifecycle {
    # 특정 속성의 변경을 Terraform이 무시하도록 설정 (수동 변경 시 유용)
    ignore_changes = [
      network, # 네트워크 설정 변경 무시
      disk     # 디스크 설정 변경 무시
    ]
  }
}
```

  3. 같은 폴더에 terraform.tfvars 파일을 만들어 민감한 정보를 저장합니다. 이 파일은 Git 등에 커밋하지 않도록 주의해야 합니다.

```bash
vi terraform.tfvars

# Proxmox API 접속 정보
# [주의] 이 파일은 .gitignore에 추가하여 버전 관리에 포함되지 않도록 하세요.
proxmox_api_url          = "https://192.168.0.3:8006/api2/json"
proxmox_api_token_id     = "terraform-prov@pve!terraform-token"
proxmox_api_token_secret = " e3f31683-a95e-42c3-b44b-XXXXXXXX"


# 가상머신 구성 정보
vm_name       = "kosa-vm-01"
proxmox_node  = "masungil1"
template_name = "ubuntu-2204-template"
ssh_public_key = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABg..."
```
  ---

  3단계: Terraform 실행 (인프라 배포)

  이제 터미널에서 프로젝트 폴더로 이동한 뒤, 아래 명령어들을 순서대로 실행합니다.

1. `terraform init`
   * 구성 파일(main.tf)을 읽고 필요한 Provider(Telmate/proxmox)를 다운로드하여 작업 환경을 초기화합니다. 프로젝트 시작 시 한 번만 실행하면 됩니다.

2. `terraform plan`
   * 작성한 코드가 현재 Proxmox 상태와 어떻게 다른지 분석하여, 어떤 리소스가 생성/변경/삭제될지에 대한 실행 계획을 보여줍니다. 실제 변경은 일어나지 않으므로 안전하게 미리 확인할 수 있습니다.

3. `terraform apply`
   * plan에서 확인한 계획을 실제로 Proxmox에 적용합니다. 중간에 실행 여부를 물어보면 yes를 입력합니다.

   이 명령이 성공적으로 완료되면 Proxmox 웹 UI에 terraform-vm-01이라는 VM이 생성된 것을 확인할 수 있습니다.

4. `terraform destroy`
   * Terraform으로 생성했던 모든 리소스를 삭제합니다. 테스트 후 VM을 깔끔하게 정리할 때 유용합니다.

  이제 Proxmox 인프라를 코드로 관리할 준비가 모두 끝났습니다! 위 예시를 바탕으로 더 복잡한 VM, 스토리지, 네트워크 설정 등을 추가하며 활용해 보세요.
