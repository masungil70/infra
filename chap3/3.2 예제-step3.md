### Terraform의 variable란 ?

Terraform의 variable은 Terraform 코드를 재사용 가능하고 유연하게 만들기 위해 사용하는 '입력 변수(Input Variable)'입니다. 코드에 값을 직접 하드코딩하는 대신, 변수를 사용하여 외부에서 값을 주입받을 수 있습니다. 이를 통해 사용자는 코드를 직접 수정하지 않고도 인프라 구성을 손쉽게 맞춤 설정할 수 있습니다.

### variable의 역할 및 장점

* 재사용성: 변수를 사용하면 동일한 코드로 다양한 환경(개발, 스테이징, 프로덕션)의 인프라를 배포할 수 있습니다. 예를 들어, VM의 사양이나 개수를 변수로 처리하면 각 환경에 맞게 다른 값을 전달하여 배포할 수 있습니다.
* 유지보수성: 변경이 필요한 값들이 변수로 한 곳에 모여 있거나 외부 파일로 관리되므로, 코드 전체를 샅샅이 뒤져 값을 수정할 필요가 없습니다.
* 보안: 비밀번호나 API 키와 같은 민감한 정보를 코드에 직접 작성하지 않고, 안전한 방법으로 외부에서 전달받을 수 있습니다.

---

### 변수 선언하기 (variable 블록)

변수는 .tf 파일에 variable 블록을 사용하여 선언합니다.

#### 기본 구조

```
variable "변수_이름" {
  type        = <데이터 타입>
  description = "이 변수에 대한 설명"
  default     = <기본값>
}
```

#### 주요 속성

* type: 변수가 받아들일 값의 데이터 타입을 지정합니다. (예: string, number, bool, list(string), map(string) 등). 타입을 명시하면 잘못된 값이 들어오는 것을 방지할 수 있습니다.
* description: 이 변수가 어떤 역할을 하는지 설명하는 문자열입니다. terraform plan 실행 시나 문서를 생성할 때 표시되어 다른 사람이 코드를 이해하는 데 도움을 줍니다.
* default: 변수 값이 외부에서 주어지지 않았을 때 사용할 기본값입니다. `default` 값이 없으면 해당 변수는 필수 입력 변수가 됩니다.
* sensitive: true로 설정하면 이 변수의 값이 Terraform의 출력(plan, apply 결과)에서 숨겨집니다. API 키나 비밀번호와 같은 민감한 정보를 다룰 때 사용합니다.

#### 예시

```
# VM 메모리 크기를 위한 변수
variable "vm_memory" {
  type        = number
  description = "가상머신에 할당할 메모리 크기 (MB)"
  default     = 2048
}

# VM 이미지 이름을 위한 변수 (필수 입력)
variable "vm_image" {
  type        = string
  description = "부팅에 사용할 VM 이미지 이름"
}
```

---

#### 변수 사용하기

선언된 변수는 코드 내에서 var. 접두사를 사용하여 참조할 수 있습니다.

```
resource "proxmox_vm_qemu" "ubuntu_vm" {
# ...
  memory = var.vm_memory  # var.vm_memory 값을 사용
  clone  = var.vm_image   # var.vm_image 값을 사용
  # ...
}
```

---

#### 변수에 값 전달하기 (우선순위 순)

Terraform은 여러 가지 방법으로 변수 값을 전달받을 수 있으며, 정해진 우선순위에 따라 최종 값을 결정합니다.

(높은 우선순위)

1. 커맨드라인 `-var` 옵션:
  * terraform apply -var="vm_memory=4096"
  * 가장 우선순위가 높으며, 다른 모든 값을 덮어씁니다.

2. `*.auto.tfvars` 파일:
  * project.auto.tfvars와 같이 .auto.tfvars로 끝나는 파일에 정의된 값들을 자동으로 로드합니다.

3. `terraform.tfvars` 파일:
  * 가장 표준적인 방법입니다. terraform.tfvars라는 이름의 파일에 변수 값을 정의해두면 Terraform이 자동으로 인식하여 사용합니다.
  * terraform.tfvars 파일 내용 예시: vm_memory = 4096

4. 환경 변수:
  * TF_VAR_<변수_이름> 형태의 환경 변수를 설정하면 자동으로 인식합니다.
  * export TF_VAR_vm_memory=4096

(낮은 우선순위)

5. `variable` 블록의 `default` 값:
  * 위의 어떤 방법으로도 값이 주어지지 않았을 때 마지막으로 사용되는 기본값입니다.

---

#### variable과 locals의 차이점 요약

  * `variable` (입력 변수): 외부로부터 값을 주입받기 위해 사용합니다. 사용자가 제어하는 값입니다.
  * `locals` (지역 변수): 코드 내부에서 값을 계산하거나 별명을 붙여 재사용하기 위해 사용합니다. 코드 작성자가 제어하는 값입니다.

variable은 Terraform 코드를 모듈화하고 재사용성을 높이는 데 필수적인 기능이므로 정확히 이해하고 사용하는 것이 매우 중요합니다.

---

### 폴더 구조

step3
├── step3.tf          # 변수 선언 및 사용 
└── terraform.tfvars  # 변수에 값 설정 

```bash
vi step3.tf

# 사용할 프로바이더와 버전 설정
terraform {
  required_providers {
    proxmox = {
      # 참고: 이 코드는 telmate/proxmox 프로바이더 문법을 기준으로 합니다.
      source  = "telmate/proxmox"
      version = "3.0.2-rc06"
    }
  }
}

# Proxmox 프로바이더 연결에 필요한 변수 선언
# 선언된 변수에 값을 설정하는 것은 terraform.tfvars 파일에서 진행합니다.
variable "proxmox_api_url" { type = string }
variable "proxmox_api_token_id" { type = string }
variable "proxmox_api_token_secret" { type = string }

# Proxmox 프로바이더 구성
provider "proxmox" {
  pm_api_url          = var.proxmox_api_url
  pm_api_token_id     = var.proxmox_api_token_id
  pm_api_token_secret = var.proxmox_api_token_secret

  # 자체 서명 인증서 사용 시 필요
  pm_tls_insecure = true
}

# Proxmox VM 리소스 정의

# 공통으로 사용할 변수들을 locals 블록에 정의하여 유지보수 용이성을 높임
locals {
  name          = "kosa-vm-03"
  template_name = "ubuntu-2204-template"
  target_node   = "masungil1"
}

resource "proxmox_vm_qemu" "ubuntu_vm" {
  # VM의 이름 설정
  name        = local.name
  # VM이 배포될 Proxmox 노드의 이름
  target_node = local.target_node
  # 복제할 템플릿의 이름
  clone       = local.template_name
  # VM 생성 시 풀 클론(독립적인 복사본)을 수행할지 여부
  full_clone  = true

  # 운영체제 타입 설정 (Cloud-Init을 사용)
  os_type = "cloud-init"
  # QEMU Guest Agent 활성화 (VM과 호스트 간 통신)
  agent   = 1

  # CPU 설정
  cpu {
    # 할당할 CPU 코어 수
    cores = 1
    # 할당할 CPU 소켓 수
    sockets = 1
  }

  # 할당할 메모리 양 (MB 단위)
  memory  = 1024
  # 메모리 벌루닝 활성화 (최소 512MB 보장)
  balloon = 512
  # SCSI 컨트롤러 하드웨어 타입 (성능 향상을 위해 VirtIO SCSI 권장)
  scsihw  = "virtio-scsi-pci"
  # 부팅 순서 (scsi0 디스크로 부팅)
  boot    = "order=scsi0"

  # 메인 디스크 설정 (루트 디스크)
  disk {
    # 디스크 슬롯 (scsi0)
    slot    = "scsi0"
    # 디스크 크기 (8GB)
    size    = "8G"
    # 디스크 종류 (일반 디스크)
    type    = "disk"
    # 디스크 저장소 (예: local-lvm)
    storage = "local-lvm"
  }

  # Cloud-Init 드라이브 설정
  disk {
    # 디스크 슬롯 (ide2는 일반적으로 Cloud-Init CD-ROM 드라이브에 사용)
    slot    = "ide2"
    # 디스크 종류 (Cloud-Init 드라이브)
    type    = "cloudinit"
    # 디스크 저장소
    storage = "local-lvm"
  }


  # 네트워크 인터페이스 설정
  network {
    # 네트워크 인터페이스 ID (net0)
    id     = 0
    # 네트워크 카드 모델 (VirtIO는 성능이 좋음)
    model  = "virtio"
    # 연결할 가상 브릿지
    bridge = "vmbr0"
  }

  # Cloud-Init을 통한 IP 설정 (DHCP로 IP 자동 할당)
  ipconfig0 = "ip=dhcp"

  # Cloud-Init 업그레이드 활성화
  ciupgrade  = true
  # Cloud-Init 사용자 이름
  ciuser     = "kosa"
  # Cloud-Init 사용자 암호
  cipassword = "kosa1004"

  # VGA 설정
  vga {
    # VGA 타입 (표준)
    type = "std"
  }

  # Terraform 라이프사이클 관리 설정
  lifecycle {
    # 특정 속성의 변경을 Terraform이 무시하도록 설정 (수동 변경 시 유용)
    ignore_changes = [
      network, # 네트워크 설정 변경 무시
      disk     # 디스크 설정 변경 무시
    ]
  }
}

```

```bash
vi terraform.tfvars

# Proxmox API 접속 정보
# [주의] 이 파일은 .gitignore에 추가하여 버전 관리에 포함되지 않도록 하세요.
proxmox_api_url          = "https://192.168.0.3:8006/api2/json"
proxmox_api_token_id     = "terraform-prov@pve!terraform-token"
proxmox_api_token_secret = "e3f31683-a95e-42c3-*****"

```

#### 실행 방법:
```bash
terraform init
terraform plan
terraform apply -auto-approve
```


생성된 가상 머신에 접속해 봅니다
```
userid : kosa
password : kosa1004
```
입력하면 로그인이 되는 것을 확인할 수 있습니다

주의 terraform 실행 시간의 2분이상 걸리는 이유

agent = 1이 설정되서 설치된 가상머신에 qemu-guest-agent가 설치되는 것을 확인 해야 terraform이 종료되는데 현재 template 이미지는 설치되지 않아 2분가 대기 하다 종료합니다

생성된 가상머신의 요약에 부분에 IP 주소가 표시되지 않습니다.

---
