# ì „ì²´ íë¦„ ìš”ì•½ 

```
[1] Ceph Cluster ìƒíƒœ ì ê²€
        â†“
[2] Cephì—ì„œ RBD Pool ìƒì„±
        â†“
[3] Proxmox Cluster â†’ Ceph Storage(RBD) ë“±ë¡
        â†“
[4] Proxmoxì—ì„œ Ceph RBD ê¸°ë°˜ VM ìƒì„±
        â†“
[5] Proxmox HA Manager êµ¬ì„±
        â†“
[6] VMì„ HA ë¦¬ì†ŒìŠ¤ë¡œ ë“±ë¡
        â†“
[7] ì¥ì•  í…ŒìŠ¤íŠ¸ (ë…¸ë“œ Down â†’ ìë™ Failover)
```

---

## 1ï¸âƒ£ Ceph Cluster ìƒíƒœ ì ê²€ (ìŠ¤í† ë¦¬ì§€ ì¤€ë¹„)

### 1-1. Ceph ìƒíƒœ í™•ì¸

Ceph MON/ê´€ë¦¬ ë…¸ë“œì—ì„œ:

```bash
ceph -s
```

ì •ìƒ ìƒíƒœ ì˜ˆì‹œ:

```
cluster:
  health: HEALTH_OK
services:
  mon: 3 daemons, quorum mon1,mon2,mon3
  mgr: active
  osd: 12 osds: 12 up, 12 in
```

âœ” í™•ì¸ í¬ì¸íŠ¸

* `HEALTH_OK`
* ëª¨ë“  OSD `up/in`
* MON quorum ì •ìƒ

---

### 1-2. RBD Pool ìƒì„± (ìŠ¤í† ë¦¬ì§€ ë…¼ë¦¬ ë‹¨ìœ„)

> Proxmox VM ë””ìŠ¤í¬ëŠ” **Ceph RBD Pool** ìœ„ì— ìƒì„±ë¨

```bash
ceph osd pool create rbd-pool 256
```

PG ìˆ˜ ê¶Œì¥ ê¸°ì¤€:

* OSD 8~12ê°œ â†’ **128~256**
* êµìœ¡/í…ŒìŠ¤íŠ¸ â†’ 128ë„ ì¶©ë¶„

---

### 1-3. RBD Pool ì´ˆê¸°í™”

```bash
rbd pool init rbd-pool
```

---

## 2ï¸âƒ£ Proxmox Cluster â†’ Ceph RBD Storage ë“±ë¡

> âš ï¸ **CephëŠ” ì™¸ë¶€ í´ëŸ¬ìŠ¤í„°**
> â†’ Proxmoxì— â€œExternal Cephâ€ í˜•íƒœë¡œ ë“±ë¡

---

### 2-1. Ceph ì¸ì¦ Keyring ì¤€ë¹„

Ceph MON ë…¸ë“œì—ì„œ:

```bash
ceph auth get-or-create client.proxmox \
  mon 'allow r' \
  osd 'allow rwx pool=rbd-pool'
```

ì¶œë ¥ ì˜ˆ:

```
[client.proxmox]
    key = AQDxxxxxxxxx==
```

ì´ Keyë¥¼ **ë³µì‚¬**

---

### 2-2. Proxmox ë…¸ë“œì— Ceph client ì„¤ì •

Proxmox ëª¨ë“  ë…¸ë“œì—ì„œ:

```bash
apt install ceph-common -y
```

---

### 2-3. Proxmox GUIì—ì„œ Ceph RBD ë“±ë¡

**Datacenter â†’ Storage â†’ Add â†’ RBD**

| í•­ëª©        | ê°’                                     |
| --------- | ------------------------------------- |
| ID        | ceph-rbd                              |
| Pool      | rbd-pool                              |
| Monitors  | `10.10.10.101 10.10.10.102 10.10.10.103 ` |
| User name | `proxmox`                             |
| Key       | (ìœ„ì—ì„œ ë³µì‚¬í•œ key)                         |
| Content   | Disk image                            |

âœ” ì €ì¥ í›„ **Status = Active** í™•ì¸

---

## 3ï¸âƒ£ Ceph RBD ê¸°ë°˜ ê°€ìƒë¨¸ì‹  ìƒì„±

### 3-1. VM ìƒì„± (GUI ê¸°ì¤€)

**Node â†’ Create VM**

* OS ISO ì„ íƒ
* CPU / Memory ì„¤ì •
* **Hard Disk**

  * Storage: `ceph-rbd`
  * Bus: `VirtIO SCSI`
  * Cache: `Write back`
  * Discard: `ON`
* Network: VirtIO

---

### 3-2. VM ë””ìŠ¤í¬ í™•ì¸

```bash
rbd ls rbd-pool
```

ì¶œë ¥ ì˜ˆ:

```
vm-101-disk-0
```

â†’ ë””ìŠ¤í¬ê°€ **Cephì— ì €ì¥ë¨**

---

## 4ï¸âƒ£ Proxmox HA Manager ì¤€ë¹„

> HAëŠ” **Proxmox Cluster + Shared Storage** ê°€ ìˆì–´ì•¼ ê°€ëŠ¥
> â†’ í˜„ì¬ êµ¬ì¡°ëŠ” HA ì¡°ê±´ ì¶©ì¡±

---

### 4-1. HA ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸

ëª¨ë“  Proxmox ë…¸ë“œì—ì„œ:

```bash
systemctl status pve-ha-lrm
systemctl status pve-ha-crm
```

ì •ìƒ:

```
active (running)
```

---

### 4-2. HA ë…¸ë“œ ìƒíƒœ í™•ì¸

```bash
ha-manager status
```

ì¶œë ¥ ì˜ˆ:

```
quorum OK
master pve-node1
```

---

## 5ï¸âƒ£ ê°€ìƒë¨¸ì‹ ì„ HA ë¦¬ì†ŒìŠ¤ë¡œ ë“±ë¡

### 5-1. GUI ë°©ì‹ (ê¶Œì¥)

**Datacenter â†’ HA â†’ Add**

| í•­ëª©            | ê°’               |
| ------------- | --------------- |
| Resource type | Virtual Machine |
| VM ID         | 101             |
| Group         | (ì„ íƒ)            |
| Max restart   | 1               |
| Max relocate  | 1               |

âœ” ì¶”ê°€ í›„ ìƒíƒœ:

```
started
```

---

### 5-2. CLI ë°©ì‹

```bash
ha-manager add vm:101
```

---

## 6ï¸âƒ£ HA ë™ì‘ ë°©ì‹ ì´í•´ (ì¤‘ìš”)

### ì¥ì•  ë°œìƒ ì‹œ íë¦„

```
Node1 Down
   â†“
HA Manager ê°ì§€
   â†“
Ceph RBD ë””ìŠ¤í¬ëŠ” ê³µìœ  ìƒíƒœ
   â†“
Node2ì—ì„œ VM ìë™ ê¸°ë™
```

âœ” VM ë””ìŠ¤í¬ ë³µì‚¬ âŒ
âœ” Ceph RBD ì¬ë§ˆìš´íŠ¸ + VM ì¬ì‹œì‘ â­•

---

## 7ï¸âƒ£ HA ì¥ì•  í…ŒìŠ¤íŠ¸ (ë°˜ë“œì‹œ ìˆ˜í–‰)

### 7-1. VM ì‹¤í–‰ ë…¸ë“œ í™•ì¸

```bash
qm status 101
```

---

### 7-2. ë…¸ë“œ ê°•ì œ ì¢…ë£Œ (í…ŒìŠ¤íŠ¸ìš©)

```bash
poweroff
```

ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨

---

### 7-3. HA ìƒíƒœ í™•ì¸

ë‹¤ë¥¸ ë…¸ë“œì—ì„œ:

```bash
ha-manager status
```

ì •ìƒ:

```
vm:101 started on pve-node2
```

ğŸ‰ **HA ì •ìƒ ë™ì‘**

---

## 8ï¸âƒ£ ìš´ì˜ ì‹œ ë°˜ë“œì‹œ ì§€ì¼œì•¼ í•  ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

### âœ” Ceph

* Public / Cluster NIC ë¶„ë¦¬
* MTU í†µì¼ (9000 or 1500)
* Scrub ì‹œê°„ ì—…ë¬´ ì™¸ ì‹œê°„ ì„¤ì •

### âœ” Proxmox

* ëª¨ë“  ë…¸ë“œ CPU íƒ€ì… í†µì¼
* Ceph ë„¤íŠ¸ì›Œí¬ëŠ” Proxmox VM íŠ¸ë˜í”½ê³¼ ë¶„ë¦¬
* fencing(Watchdog) í™œì„±í™” ê¶Œì¥

---

## 9ï¸âƒ£ ì „ì²´ ì•„í‚¤í…ì²˜ ASCII ë‹¤ì´ì–´ê·¸ë¨

```
    [ Proxmox Cluster ]
 pve1   pve2   pve3   pve4
   |      |     |      |
   +------- 10G -------+
             |
          Ceph RBD
             |
      [ Ceph Cluster ]
 osd1   osd2   osd3   osd4
```

---


ğŸ‘‰ **ë‹¤ìŒìœ¼ë¡œ ì–´ë–¤ ë‹¨ê³„ê¹Œì§€ êµ¬í˜„í•  ê³„íšì¸ê°€ìš”?**
