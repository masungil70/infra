## Proxmox에서 Ubuntu 클라우드 이미지를 사용하여 가상머신(VM)을 생성

핵심 개념: `cloud-init`과 클라우드 이미지

1. `cloud-init`: VM이 처음 부팅될 때, 호스트 환경으로부터 사용자 이름, 비밀번호, SSH 키, 네트워크 설정, 실행 스크립트 등 다양한 초기 설정 정보를 받아와 자동으로 VM을 구성해주는 도구입니다.
2. 클라우드 이미지: cloud-init이 미리 설치되고 설정되어 있는 OS 이미지 파일입니다. 일반적인 설치 ISO 파일이 아닙니다.

---

### `cloud-init` 템플릿 생성 및 활용

1단계: Ubuntu 클라우드 이미지 다운로드

먼저 Proxmox 서버에 접속하여 템플릿으로 사용할 Ubuntu 클라우드 이미지를 다운로드합니다.

1. Proxmox 셸 접속:
   * Proxmox 웹 UI에 로그인합니다.
   * 좌측 트리에서 여러분의 [노드 이름]을 선택한 후, 상단 메뉴에서 [셸]을 클릭하여 터미널에 접속합니다. (또는 SSH로 직접 접속해도 됩니다.)
2. 클라우드 이미지 다운로드:
   * Ubuntu의 최신 LTS 버전(Long Term Support)인 22.04 (Jammy Jellyfish)의 클라우드 이미지를 다운로드합니다.
   * wget 명령어를 사용하며, .img 파일이지만 실제로는 qcow2 형식입니다.

```#!/bin/bash
wget https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img
```

   * 참고: 다른 버전의 Ubuntu를 원하시면 https://cloud-images.ubuntu.com/ 에서 원하는 버전(예: focal (20.04), noble (24.04))을 찾아 해당 디렉터리 안의 current 폴더에서 *-server-cloudimg-amd64.img 파일을 다운로드하시면 됩니다.

3. 다운로드 확인:
   * ls -lh 명령어로 파일이 정상적으로 다운로드되었는지 확인합니다.

2단계: 템플릿의 기반이 될 VM 생성 (OS 미포함)

Proxmox 웹 UI를 통해 새로운 VM을 생성하되, 이 VM에는 아직 OS를 설치하지 않습니다.

   1. VM 생성 마법사 시작:
       * Proxmox 웹 UI 우측 상단의 [VM 생성] 버튼을 클릭합니다.
   2. 일반 (General):
       * 노드(Node): VM을 생성할 Proxmox 노드를 선택합니다. (보통 하나만 있으면 자동 선택)
       * VM ID: 고유한 ID를 입력합니다. (예: 9000 - 템플릿용 VM은 높은 ID를 부여하는 관례가 있습니다.)
       * 이름(Name): ubuntu-2204-base-template과 같이 식별하기 쉬운 이름을 입력합니다.
       * [다음] 클릭
   3. OS:
       * '미디어 사용 안함 (Do not use any media)'을 반드시 선택합니다. ISO 파일로 설치하는 것이 아니기 때문입니다.
       * [다음] 클릭
   4. 시스템 (System):
       * 그래픽카드(Graphic card): Default 또는 VirtIO-GPU
       * BIOS: OVMF (UEFI) 선택 (최신 시스템 및 cloud-init 사용에 권장)
       * 머신(Machine): q35 선택 (최신 시스템에 권장)
       * Qemu Agent: [체크] (VM 내부와 호스트 간 통신에 필요)
       * [다음] 클릭
   5. 디스크 (Disks):
       * 기존에 있는 디스크를 삭제하고 [다음]을 클릭합니다. 다운로드한 이미지를 나중에 직접 연결할 것입니다.
   6. CPU:
       * 소켓(Sockets): 1
       * 코어(Cores): 2 (최소 2코어 이상 권장)
       * [다음] 클릭
   7. 메모리 (Memory):
       * 2048 MB (2GB) 이상을 권장합니다.
       * [다음] 클릭
   8. 네트워크 (Network):
       * 브리지(Bridge): vmbr0 (기본값)
       * 모델(Model): VirtIO (paravirtualized) 선택 (가장 좋은 성능)
       * [다음] 클릭
   9. 최종 확인 (Confirm):
       * 설정 내용을 검토하고 [마침]을 클릭합니다.

3단계: 다운로드한 이미지를 디스크로 가져오기

다운로드한 클라우드 이미지를 방금 생성한 VM의 디스크로 변환하여 연결합니다.

1. 셸에서 이미지 임포트:
   * 다시 Proxmox 셸로 돌아와 아래 명령어를 실행합니다.

```#!/bin/bash
   1     # qm importdisk <VM_ID> <이미지_파일명> <디스크를_저장할_스토리지_이름>
   2     qm importdisk 9000 jammy-server-cloudimg-amd64.img local-lvm
```

   * 9000: 2단계에서 생성한 VM의 ID
   * jammy-server-cloudimg-amd64.img: 1단계에서 다운로드한 파일명
   * local-lvm: 디스크를 저장할 Proxmox 스토리지의 이름입니다. (Proxmox 웹 UI의 좌측 메뉴에서 [노드 이름] > [디스크] 또는 [데이터센터] > [스토리지]에서 확인 가능하며, 보통 local-lvm 또는 local입니다.)

2. 임포트 확인 (웹 UI):
   * Proxmox 웹 UI에서 생성한 VM(ubuntu-2204-base-template)을 선택하고 [하드웨어] 탭으로 이동합니다.
   * qm importdisk 명령으로 인해 미사용 디스크 (Unused Disk)가 새로 추가된 것을 확인할 수 있습니다.

4단계: VM에 디스크 및 Cloud-Init 드라이브 연결

이제 가져온 디스크와 cloud-init 드라이브를 VM에 정식으로 연결합니다.

1. '미사용 디스크' 연결:
   * [하드웨어] 탭에서 '미사용 디스크 0'을 선택하고 [편집] 버튼을 클릭합니다.
   * 버스/장치(Bus/Device): SCSI 또는 VirtIO Block (VirtIO가 성능이 더 좋지만, 부팅 문제가 발생하면 SCSI로 변경해 볼 수 있습니다.)
   * [추가] 버튼을 클릭하여 디스크를 연결합니다.
2. CD/DVD 드라이브 분리:
   * 목록에 CD/DVD 드라이브가 있다면 선택 후 [분리] 버튼을 클릭합니다. (OS 설치용이 아니므로 필요 없습니다.)
3. Cloud-Init 드라이브 추가:
   * [추가] -> [Cloud-Init 드라이브]를 선택합니다.
   * 버스/장치(Bus/Device): IDE (기본값)
   * [추가] 버튼을 클릭합니다. 이 드라이브가 Proxmox가 cloud-init에 설정값을 전달하는 통로 역할을 합니다.

5단계: 부팅 순서 및 디스크 크기 설정

VM이 올바른 디스크로 부팅하고, 디스크 크기를 0.5G 증가 하도록 설정합니다.

1. 부팅 순서 설정:
   * VM의 [옵션] 탭으로 이동합니다.
   * [부팅 순서]를 더블클릭합니다.
   * '활성화된 디스크' 중에서 방금 연결한 디스크(예: scsi0 또는 virtio0)를 가장 위로 끌어올려 첫 번째 부팅 장치로 지정합니다.
   * [확인]을 클릭합니다.

2. 디스크 크기 증가:
   * 활성화된 디스크(예: scsi0 또는 virtio0)선택합니다.
   * [디스크 동작] -> [크기조정]를 클릭합니다.
   * 크기증분(GiB)' 부분에 0.5을 입력하고 [디스크 크기 조정] 버튼을 클릭합니다.
  
6단계: VM의 Cloud-Init 설정 및 QEMU 설치

   1. VM의 Cloud-Init 설정:
       * [Cloud-Init] 탭으로 이동합니다.
       * 사용자(User): kosa
       * 암호(Password): 사용자에게 설정할 강력한 암호를 입력합니다(kosa1004).
       * SSH 공개키(SSH public Key): (강력 추천) 로컬 PC의 SSH 공개키(~/.ssh/id_rsa.pub 파일 내용)를 복사하여 붙여넣습니다. 이렇게 하면 비밀번호 없이 SSH 접속이 가능해집니다.
       * IP 구성: `DHCP` 동적 IP 할당으로 설정합니다
       * 모든 설정을 마치면 [재생성] 버튼을 눌러 적용합니다.

   2. VM 시작 및 접속 확인:
       * 새로 생성된 VM을 [시작]합니다.
       * 몇 초에서 1분 정도 기다립니다. cloud-init이 VM 내부에서 초기 설정을 진행하는 시간이 필요합니다.
       * Proxmox 웹 UI에서 해당 VM의 [콘솔] 탭을 엽니다.
       * 부팅이 완료되면 kosa라는 사용자 이름으로 로그인을 시도합니다.
       * 비밀번호를 입력하고 로그인을 합니다.
       * 로그인에 성공하면, 아래 명령어를 실행하여 게스트 에이전트를 설치합니다.

```#!/bin/bash
sudo apt update
sudo apt install qemu-guest-agent -y
sudo cloud-init clean --logs 
sudo shutdown -h now
```

7단계: VM을 템플릿으로 변환

  모든 설정이 완료된 VM을 다른 VM들을 복제하기 위한 원본인 템플릿으로 만듭니다.

   1. Proxmox 웹 UI 좌측 트리 메뉴에서 ubuntu-2204-base-template VM을 마우스 오른쪽 버튼으로 클릭합니다.
   2. [템플릿으로 변환]을 선택합니다.
   3. 확인 창이 뜨면 [예]를 클릭합니다. VM 아이콘이 바뀌면서 템플릿으로 변환됩니다. (템플릿은 직접 시작할 수 없습니다.)

8단계: 템플릿을 사용하여 새 VM 생성 및 테스트

이제 이 템플릿을 사용하여 cloud-init 기능이 잘 작동하는 새로운 VM을 생성하고 테스트합니다.

   1. 복제 마법사 시작:
       * 좌측 트리에서 ubuntu-2204-base-template 템플릿을 마우스 오른쪽 버튼으로 클릭하고 [복제]를 선택합니다.
   2. 복제 설정:
       * VM ID: 새로운 VM ID를 입력합니다. (예: 100)
       * 호스트 이름(Hostname): my-ubuntu-server와 같이 새 VM의 이름을 입력합니다.
       * 모드(Mode): '완전한 복제(Full Clone)'를 선택합니다. (템플릿과의 의존성 없이 독립적인 VM을 만듭니다.)
       * [복제] 버튼을 클릭합니다.
   3. 새 VM의 Cloud-Init 설정:
       * 복제가 완료되면 새로 생성된 VM(my-ubuntu-server)을 선택하고 [Cloud-Init] 탭으로 이동합니다.
       * 사용자(User): kosa
       * 암호(Password): 사용자에게 설정할 강력한 암호를 입력합니다(kosa1004)
       * SSH 공개키(SSH public Key): (강력 추천) 로컬 PC의 SSH 공개키(~/.ssh/id_rsa.pub 파일 내용)를 복사하여 붙여넣습니다. 이렇게 하면 비밀번호 없이 SSH 접속이 가능해집니다.
       * IP 구성:`DHCP` 동적 IP 할당으로 선택합니다
       * 모든 설정을 마치면 [재생성] 버튼을 눌러 적용합니다.

   4. 디스크 크기 증가:
        * 활성화된 디스크(예: scsi0 또는 virtio0)선택합니다.
        * [디스크 동작] -> [크기조정]를 클릭합니다.
        * 크기증분(GiB)' 부분에 원하는 크기 (예 : 20) 입력하고 [디스크 크기 조정] 버튼을 클릭합니다.

   5. VM 시작 및 접속 확인:
       * 새로 생성된 my-ubuntu-server VM을 [시작]합니다.
       * 몇 초에서 1분 정도 기다립니다. cloud-init이 VM 내부에서 초기 설정을 진행하는 시간이 필요합니다.
       * VM의 [요약] 탭으로 이동합니다. 'Qemu Agent'가 활성화되어 있다면 여기에 VM의 IP 주소가 표시될 것입니다.
       * 로컬 PC의 터미널에서 SSH로 접속해 봅니다.
         ssh kosa@<VM의_IP주소>
       * SSH 공개키를 사용했다면 암호 없이 접속될 것이고, 암호만 설정했다면 비밀번호를 입력하라는 메시지가 나타날 것입니다.


### Proxmox에서 Ubuntu Cloud Image를 빠르게 쓰도록 최적화 스크립트 실행 
```bash
sudo apt remove --purge cloud-init -y
sudo rm -rf /etc/cloud /var/lib/cloud
sudo apt remove multipath-tools -y
sudo systemctl disable --now apparmor


GRUB_CMDLINE_LINUX="net.ifnames=0 biosdevname=0"
sudo update-grub

sudo systemctl disable systemd-networkd-wait-online.service
sudo systemctl mask systemd-networkd-wait-online.service

sudo systemctl stop snapd
sudo apt purge snapd -y
sudo rm -rf /snap /var/snap /var/lib/snapd
sudo rm -rf /var/lib/snapd/*
sudo rm -rf /var/cache/snapd/

sudo apt purge cloud-init -y
sudo rm -rf /etc/cloud /var/lib/cloud

sudo vi /etc/netplan/50-cloud-init.yaml 파일에서 아래 dhcp 부분 삭제 후 저장 

 dhcp4: true 삭제
 dhcp6: true 삭제
```
