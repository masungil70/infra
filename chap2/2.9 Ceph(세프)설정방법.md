## Ceph(ì„¸í”„) ì„¤ì • ë°©ë²• 

10G ì „ìš© ë„¤íŠ¸ì›Œí¬ ì¹´ë“œ ì„¤ì¹˜ ì ˆì°¨ 

1. ì„¤ì¹˜í•˜ë ¤ëŠ” ì»´í“¨í„°ì˜ ì „ì›ì„ off í•œë‹¤
2. ë©”ì¸ë³´ë“œì— NIC ì¹´ë“œë¥¼ ì—°ê²°í•œë‹¤
3. ë©”ì¸ë³´ë“œì— ì—°ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” PCI 4 ë°°ì† portê°€ ìˆì–´ì•¼ í•œë‹¤
4. ë©”ì¸ë³´ë“œì— NICì„ ì—°ê²°í•˜ê³  SFP ì¼€ì´ë¸”ì„ ìŠ¤ìœ„ì¹˜ì™€ ì—°ê²°í•œë‹¤
5. ì»´í“¨í„°ë¥¼ ë¶€íŒ…í•œë‹¤

### 1. PCIe ì¥ì¹˜ ì¸ì‹ ì—¬ë¶€ í™•ì¸
```bash
lspci | grep -i mellanox

```

ì •ìƒ ì˜ˆì‹œ:

```text
01:00.0 Ethernet controller: Mellanox Technologies MT27500 Family [ConnectX-3]
```

### 2. ì»¤ë„ ë“œë¼ì´ë²„ ë¡œë“œ í™•ì¸ (mlx4_en)

```bash
lsmod | grep mlx4
```

### 3. ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ìƒì„± í™•ì¸ 
```
ip a
```

ì •ìƒ ì˜ˆì‹œ :

```text

1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute
       valid_lft forever preferred_lft forever
2: nic0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel master vmbr0 state UP group default qlen 1000
    link/ether d8:43:ae:2b:6e:b5 brd ff:ff:ff:ff:ff:ff
    altname enp0s31f6
    altname enxd843ae2b6eb5
3: nic1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9000 qdisc mq master vmbr1 state DOWN group default qlen 1000
    link/ether f4:52:14:19:bd:70 brd ff:ff:ff:ff:ff:ff
    altname enxf4521419bd70
4: nic2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9000 qdisc mq master vmbr2 state DOWN group default qlen 1000
    link/ether f4:52:14:19:bd:71 brd ff:ff:ff:ff:ff:ff
    altname enxf4521419bd71
5: vmbr0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether d8:43:ae:2b:6e:b5 brd ff:ff:ff:ff:ff:ff
    inet 192.168.3.94/24 scope global vmbr0
       valid_lft forever preferred_lft forever
    inet6 fe80::da43:aeff:fe2b:6eb5/64 scope link proto kernel_ll
       valid_lft forever preferred_lft forever
```

ë˜ëŠ” 

```
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute
       valid_lft forever preferred_lft forever
2: eno1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel master vmbr0 state UP group default qlen 1000
    link/ether d8:43:ae:40:e7:8e brd ff:ff:ff:ff:ff:ff
    altname enp0s31f6
    altname enxd843ae40e78e
3: enp1s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9000 qdisc mq master vmbr1 state UP group default qlen 1000
    link/ether 00:02:c9:1f:0f:00 brd ff:ff:ff:ff:ff:ff
    altname enx0002c91f0f00
4: enp1s0d1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9000 qdisc mq master vmbr2 state UP group default qlen 1000
    link/ether 00:02:c9:1f:0f:01 brd ff:ff:ff:ff:ff:ff
    altname enx0002c91f0f01
5: vmbr0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether d8:43:ae:40:e7:8e brd ff:ff:ff:ff:ff:ff
    inet 192.168.3.107/24 scope global vmbr0
       valid_lft forever preferred_lft forever
    inet6 fe80::da43:aeff:fe40:e78e/64 scope link proto kernel_ll
       valid_lft forever preferred_lft forever
```
ë¬¼ë¦¬ì  NIC ëª…ìœ¼ë¥´ í™•ì¸í•œë‹¤ 

nic1, nic2, enp1s0, enp1s0d1ì™€ ê°™ì€ ì´ë¦„ì„ ìˆëŠ”ì§€ í™•ì¸ í•©ë‹ˆë‹¤ 

### 3. ë„¤íŠ¸ì›©íŠ¸ ì¸í„°í˜ì´ìŠ¤ì— ë‚´ë¶€ IPë¥¼ ì„¤ì •
```bash
vi /etc/network/interfaces

auto lo
iface lo inet loopback

#ì™¸ë¶€ ì¸í„°ë„·ì„ ìœ„í•œ ì„¤ì • 
iface nic0 inet manual

#ì™¸ë¶€ ì¸í„°ë„·ì„ ìœ„í•œ ì„¤ì • ip ì„¤ì • 
auto vmbr0
iface vmbr0 inet static
        address 192.168.3.94/24
        gateway 192.168.3.1
        bridge-ports nic0
        bridge-stp off
        bridge-fd 0

#1ë²ˆì§¸ 10G NIC ë‚´ë¶€ í†µì‹ ì„ ìœ„í•œ ì„¤ì • ip ì„¤ì • 
iface nic1 inet manual
        mtu 9000

auto vmbr1
iface vmbr1 inet static
        address 10.10.10.101/24
        bridge-ports nic1
        bridge-stp off
        bridge-fd 0
        mtu 9000

#2ë²ˆì§¸ 10G NIC ë‚´ë¶€ í†µì‹ ì„ ìœ„í•œ ì„¤ì • ip ì„¤ì • 
iface nic2 inet manual
        mtu 9000

auto vmbr2
iface vmbr2 inet static
        address 10.10.20.101/24
        bridge-ports nic2
        bridge-stp off
        bridge-fd 0
        mtu 9000

source /etc/network/interfaces.d/*
```

### 4. ìˆ˜ì •í•œ NIC ì •ë³´ë¥¼ ë¦¬ë¡œë”©

```bash
ifreload -a 
```

### 5. 10G IPë¥¼ í™•ì¸

```bash
ip a

ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute
       valid_lft forever preferred_lft forever
2: nic0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel master vmbr0 state UP group default qlen 1000
    link/ether d8:43:ae:2b:6e:b5 brd ff:ff:ff:ff:ff:ff
    altname enp0s31f6
    altname enxd843ae2b6eb5
3: nic1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9000 qdisc mq master vmbr1 state UP group default qlen 1000
    link/ether f4:52:14:19:bd:70 brd ff:ff:ff:ff:ff:ff
    altname enxf4521419bd70
4: nic2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9000 qdisc mq master vmbr2 state UP group default qlen 1000
    link/ether f4:52:14:19:bd:71 brd ff:ff:ff:ff:ff:ff
    altname enxf4521419bd71
5: vmbr0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether d8:43:ae:2b:6e:b5 brd ff:ff:ff:ff:ff:ff
    inet 192.168.3.94/24 scope global vmbr0
       valid_lft forever preferred_lft forever
    inet6 fe80::da43:aeff:fe2b:6eb5/64 scope link proto kernel_ll
       valid_lft forever preferred_lft forever
6: vmbr1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9000 qdisc noqueue state UP group default qlen 1000
    link/ether f4:52:14:19:bd:70 brd ff:ff:ff:ff:ff:ff
    inet 10.10.10.101/24 scope global vmbr1
       valid_lft forever preferred_lft forever
    inet6 fe80::f652:14ff:fe19:bd70/64 scope link proto kernel_ll
       valid_lft forever preferred_lft forever
7: vmbr2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9000 qdisc noqueue state UP group default qlen 1000
    link/ether f4:52:14:19:bd:71 brd ff:ff:ff:ff:ff:ff
    inet 10.10.20.101/24 scope global vmbr2
       valid_lft forever preferred_lft forever
    inet6 fe80::f652:14ff:fe19:bd71/64 scope link proto kernel_ll
       valid_lft forever preferred_lft forever

```

nic1, nic2ì˜ ê²°ê³¼ì— UPë¼ê³  í‘œì‹œê°€ ë˜ì–´ì•¼ í•¨

### 6. 10G ì†ë„ í™•ì¸ 
```bash
# ì†ë„ë¥¼ í™•ì¸ í•  ìˆ˜ ìˆëŠ” í”„ë¡œê·¸ë¨  
apt install -y iperf3

#ì„¤ì¹˜ì¤‘ ì„œë²„ êµ¬ë™ í™•ì¸í•  ê²ƒ 

#ë‹¤ë¥¸ ì„œë²„ì— ì ‘ì†í•˜ì—¬ ì†ë„ë¥¼ í™•ì¸í•œë‹¤
iperf3 -c IP

iperf3 -c 10.10.10.104
Connecting to host 10.10.10.104, port 5201
[  5] local 10.10.10.101 port 40416 connected to 10.10.10.104 port 5201
[ ID] Interval           Transfer     Bitrate         Retr  Cwnd
[  5]   0.00-1.00   sec  1.16 GBytes  9.91 Gbits/sec    0   1.30 MBytes
[  5]   1.00-2.00   sec  1.15 GBytes  9.89 Gbits/sec    0   1.30 MBytes
[  5]   2.00-3.00   sec  1.15 GBytes  9.89 Gbits/sec    0   1.30 MBytes
[  5]   3.00-4.00   sec  1.15 GBytes  9.89 Gbits/sec    0   1.30 MBytes
[  5]   4.00-5.00   sec  1.15 GBytes  9.88 Gbits/sec    0   1.30 MBytes
[  5]   5.00-6.00   sec  1.15 GBytes  9.88 Gbits/sec    0   1.30 MBytes
[  5]   6.00-7.00   sec  1.15 GBytes  9.89 Gbits/sec    0   1.30 MBytes
[  5]   7.00-8.00   sec  1.15 GBytes  9.89 Gbits/sec    0   1.30 MBytes
[  5]   8.00-9.00   sec  1.15 GBytes  9.88 Gbits/sec    0   1.30 MBytes
[  5]   9.00-10.00  sec  1.15 GBytes  9.90 Gbits/sec    0   1.30 MBytes
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec  11.5 GBytes  9.89 Gbits/sec    0            sender
[  5]   0.00-10.00  sec  11.5 GBytes  9.89 Gbits/sec                  receiver

iperf Done.

```

### 7. 10Gì˜ ì†ë„ê°€ ë‚˜ì˜¤ì§€ ì•Šì„ ë•ŒëŠ” ë§ì€ ê²½ìš°ê°€ ìˆìŒ 

1. ìŠ¤ìœ„ì¹˜ ë¦¬ìŠ¤íƒ€íŠ¸ë¥¼ í•œë‹¤
2. ë©”ì¸ë³´ë“œì—ì„œ ì œê³µí•˜ëŠ” PCIì˜ ì†ë„ê°€ 4ë°°ì† ì´ìƒì¸ì§€ë¥¼ í™•ì¸í•œë‹¤
3. biosì—  PCIë¥¼ 4ë°°ì† ì´ìƒì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ë‹¤.
4. ìŠ¤ìœ„ì¹˜ì˜ MTUë¥¼ 9000ìœ¼ë¡œ ì„¤ì •í•œë‹¤

### 8. ìŠ¤ìœ„ì¹˜ì˜ MTUë¥¼ 9000ìœ¼ë¡œ ì„¤ì •

1. ìŠ¤ìœ„ì¹˜ë¥¼ RC232Cë¡œ ì»´í“¨í„°ì™€ ì—°ê²°í•œë‹¤.
2. USB2COM í¬íŠ¸ê°€ ì–´ë–¤ í¬íŠ¸ì— ë°°ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•œë‹¤
3. ì¥ì¹˜ê´€ë¦¬ì <img width="1702" height="1053" alt="image" src="https://github.com/user-attachments/assets/eb8b87d4-7867-42d4-9e31-90173d7d0b54" />
4. puttyë¥¼ ì´ìš©í•˜ì—¬ ì‹œë¦¬ì–¼ ì—°ê²°í•œë‹¤
5. <img width="829" height="810" alt="image" src="https://github.com/user-attachments/assets/da8ceb57-0800-4f9f-8526-acc8d23e6354" />
6. ìŠ¤ìœ„ì¹˜ì˜ ì „ì›ì„ ë‹¤ì‹œ ì¼ ë‹¤
7. puttyì˜ í„°ë¯¸ë„ ì°½ì— ë¡œê·¸ê°€ ì¶œë ¥ëœë‹¤
8. admin/admin ìœ¼ë¡œ ë¡œê·¸ì¸í•œë‹¤
9.  <img width="1156" height="656" alt="image" src="https://github.com/user-attachments/assets/91bf5c77-75bd-48d1-8163-07b1bb0dba3e" />
10. config terminal
11. mtu 9000
12. exit
13. write ìœ¼ë¡œ í˜„ì¬ì˜ ìƒíƒœë¥¼ ì €ì¥í•œë‹¤
14. show interface ëª…ë ¹ìœ¼ë¡œ ê° í¬íŠ¸ì˜ mtu ê°€ 9000ìœ¼ë¡œ ì„¤ì •ëœ ê²ƒì„ í™•ì¸í•œë‹¤
15. <img width="1156" height="656" alt="image" src="https://github.com/user-attachments/assets/c4c6481e-21c0-4587-a85d-75cfef076d94" />

---

ìƒí™© ì •ë¦¬ë¶€í„° í•˜ê³  ê°€ì¥ ì•ˆì „í•œ Ceph OSD êµ¬ì„± ì ˆì°¨ë¥¼ ë‹¨ê³„ë³„ë¡œ ì •ë¦¬í•´ì¤„ê²Œìš”.
(ì§€ê¸ˆ ìƒíƒœëŠ” ì•„ì£¼ ì „í˜•ì ì¸ Proxmox + Ceph ì¤€ë¹„ ë‹¨ê³„ì…ë‹ˆë‹¤)

### 1. í˜„ì¬ ë””ìŠ¤í¬ ìƒíƒœ ìš”ì•½ (ì¤‘ìš”)
```text
ğŸ”¹ nvme0n1 (476G)
Proxmox OS ì „ìš©
/ , swap, pve-data
```
ğŸ‘‰ ê±´ë“œë¦¬ë©´ ì•ˆ ë¨
```text
ğŸ”¹ sda (1TB HDD)
ì˜ˆì „ì— Proxmox ì„¤ì¹˜ì— ì‚¬ìš©ëœ í”ì  ì¡´ì¬
VG ì´ë¦„: pve-OLD-E7ADA11C
```
Ceph OSDë¡œ ì‚¬ìš©í•˜ë ¤ë©´ ì™„ì „ ì´ˆê¸°í™” í•„ìš”

### âš ï¸ ì¤‘ìš”

Ceph OSDëŠ” ì ˆëŒ€ LVM ìœ„ì— ë§Œë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤
â†’ ë””ìŠ¤í¬ ì „ì²´ë¥¼ RAW ìƒíƒœë¡œ ì‚¬ìš©

### ì „ì²´ ì ˆì°¨ ìš”ì•½ (ì •ì„ ë£¨íŠ¸)
1. sdaì— ë‚¨ì•„ìˆëŠ” LVM / íŒŒí‹°ì…˜ ì™„ì „ ì œê±°
2. ë””ìŠ¤í¬ë¥¼ "ë¹ˆ ë””ìŠ¤í¬" ìƒíƒœë¡œ ë§Œë“¤ê¸°
3. Proxmox GUI ë˜ëŠ” CLIì—ì„œ Ceph OSD ìƒì„±
4. Ceph ìƒíƒœ í™•ì¸

### 2. sda ê¸°ì¡´ LVM / íŒŒí‹°ì…˜ ì™„ì „ ì œê±°
1. LVM ë…¼ë¦¬ ë³¼ë¥¨ ì œê±°
lvremove -y pve-OLD-E7ADA11C/data
lvremove -y pve-OLD-E7ADA11C/swap
lvremove -y pve-OLD-E7ADA11C/root


í™•ì¸:
```bash
lvs
```
2. VG ì œê±°
vgremove -y pve-OLD-E7ADA11C


í™•ì¸:
```bash
vgs
```
3. PV ì œê±°
```bash
pvremove -y /dev/sda3
```

í™•ì¸:
```bash
pvs
```
### 3. íŒŒí‹°ì…˜ í…Œì´ë¸” ì™„ì „ ì‚­ì œ (ì¤‘ìš”)
ë°©ë²• 1ï¸âƒ£ (ê¶Œì¥ â€“ ê°€ì¥ ê¹¨ë—)
```bash
sgdisk --zap-all /dev/sda
```

ë˜ëŠ”
```bash
wipefs -a /dev/sda
```
ì¶”ê°€ë¡œ í™•ì‹¤íˆ ì§€ìš°ê³  ì‹¶ë‹¤ë©´ (ì„ íƒ)
```bash
dd if=/dev/zero of=/dev/sda bs=1M count=100
```
ì¬ë¶€íŒ… ë˜ëŠ” ì»¤ë„ ë°˜ì˜
```bash
partprobe
```

ë˜ëŠ”
```bash
reboot
```
ìƒíƒœ í™•ì¸ (ì´ê²Œ ë‚˜ì™€ì•¼ ì •ìƒ)
```bash
lsblk
```

ì •ìƒ ì˜ˆì‹œ:
```text
sda   8:0   0 931.5G 0 disk
```

âŒ íŒŒí‹°ì…˜ì´ ë³´ì´ë©´ ì•ˆ ë¨
